name: Build GCP Image

on:
  workflow_dispatch:
    inputs:
      source_repo_url:
        description: 'Source repository URL (e.g., https://github.com/user/demo-repo)'
        required: true
        type: string
      source_repo_ref:
        description: 'Branch, tag, or commit SHA to build from'
        required: true
        default: 'main'
        type: string
      image_name:
        description: 'Name for the GCP image (e.g., my-workshop)'
        required: true
        type: string
      image_family:
        description: 'Image family for versioning (e.g., my-workshop-v1)'
        required: true
        default: 'generic-workshop'
        type: string
      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      gcp_region:
        description: 'GCP Region'
        required: false
        default: 'us-east1'
        type: string
      gcp_zone:
        description: 'GCP Zone'
        required: false
        default: 'us-east1-b'
        type: string
      disk_size:
        description: 'Disk size in GB'
        required: false
        default: '100'
        type: string

  repository_dispatch:
    types: [build-image]

env:
  PACKER_VERSION: '1.10.0'

jobs:
  validate-and-build:
    name: Validate and Build Image
    runs-on: ubuntu-latest
    outputs:
      image_id: ${{ steps.get_image_info.outputs.image_id }}
      image_name: ${{ steps.get_image_info.outputs.image_name }}
      image_self_link: ${{ steps.get_image_info.outputs.image_self_link }}

    steps:
      - name: Set input variables
        id: set_inputs
        run: |
          # Handle inputs from both workflow_dispatch and repository_dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "source_repo_url=${{ github.event.client_payload.source_repo_url }}" >> $GITHUB_OUTPUT
            echo "source_repo_ref=${{ github.event.client_payload.source_repo_ref || 'main' }}" >> $GITHUB_OUTPUT
            echo "image_name=${{ github.event.client_payload.image_name }}" >> $GITHUB_OUTPUT
            echo "image_family=${{ github.event.client_payload.image_family || 'generic-workshop' }}" >> $GITHUB_OUTPUT
            echo "gcp_project_id=${{ github.event.client_payload.gcp_project_id }}" >> $GITHUB_OUTPUT
            echo "gcp_region=${{ github.event.client_payload.gcp_region || 'us-east1' }}" >> $GITHUB_OUTPUT
            echo "gcp_zone=${{ github.event.client_payload.gcp_zone || 'us-east1-b' }}" >> $GITHUB_OUTPUT
            echo "disk_size=${{ github.event.client_payload.disk_size || '100' }}" >> $GITHUB_OUTPUT
          else
            echo "source_repo_url=${{ inputs.source_repo_url }}" >> $GITHUB_OUTPUT
            echo "source_repo_ref=${{ inputs.source_repo_ref }}" >> $GITHUB_OUTPUT
            echo "image_name=${{ inputs.image_name }}" >> $GITHUB_OUTPUT
            echo "image_family=${{ inputs.image_family }}" >> $GITHUB_OUTPUT
            echo "gcp_project_id=${{ inputs.gcp_project_id }}" >> $GITHUB_OUTPUT
            echo "gcp_region=${{ inputs.gcp_region }}" >> $GITHUB_OUTPUT
            echo "gcp_zone=${{ inputs.gcp_zone }}" >> $GITHUB_OUTPUT
            echo "disk_size=${{ inputs.disk_size }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout image builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Clone source repository
        run: |
          echo "Cloning source repository: ${{ steps.set_inputs.outputs.source_repo_url }}"
          git clone --depth 1 --branch ${{ steps.set_inputs.outputs.source_repo_ref }} ${{ steps.set_inputs.outputs.source_repo_url }} source
          
      - name: Validate source repository structure
        run: |
          echo "Validating repository structure..."
          
          # Check for required files
          if [ ! -f "source/docker-compose.yml" ]; then
            echo "âŒ ERROR: docker-compose.yml not found in source repository"
            echo "Please ensure your repository contains a docker-compose.yml file"
            exit 1
          fi
          
          if [ ! -f "source/start.sh" ]; then
            echo "âŒ ERROR: start.sh not found in source repository"
            echo "Please ensure your repository contains a start.sh file"
            exit 1
          fi
          
          echo "âœ… Repository structure is valid"
          echo "Found files:"
          ls -la source/
          
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}
          
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Initialize Packer
        run: |
          cd builder/packer
          packer init generic-image.pkr.hcl
          
      - name: Validate Packer template
        run: |
          cd builder/packer
          packer validate \
            -var "project_id=${{ steps.set_inputs.outputs.gcp_project_id }}" \
            -var "image_name=${{ steps.set_inputs.outputs.image_name }}" \
            -var "image_family=${{ steps.set_inputs.outputs.image_family }}" \
            -var "zone=${{ steps.set_inputs.outputs.gcp_zone }}" \
            -var "region=${{ steps.set_inputs.outputs.gcp_region }}" \
            -var "disk_size=${{ steps.set_inputs.outputs.disk_size }}" \
            -var "source_content_path=../../source" \
            generic-image.pkr.hcl

      - name: Build GCP image with Packer
        id: packer_build
        run: |
          cd builder/packer
          echo "Starting Packer build..."
          packer build \
            -var "project_id=${{ steps.set_inputs.outputs.gcp_project_id }}" \
            -var "image_name=${{ steps.set_inputs.outputs.image_name }}" \
            -var "image_family=${{ steps.set_inputs.outputs.image_family }}" \
            -var "zone=${{ steps.set_inputs.outputs.gcp_zone }}" \
            -var "region=${{ steps.set_inputs.outputs.gcp_region }}" \
            -var "disk_size=${{ steps.set_inputs.outputs.disk_size }}" \
            -var "source_content_path=../../source" \
            generic-image.pkr.hcl | tee packer-output.log

          echo "âœ… Packer build completed"

      - name: Get image information
        id: get_image_info
        run: |
          echo "Fetching image information from GCP..."

          # Get the most recent image from the family
          IMAGE_INFO=$(gcloud compute images describe-from-family ${{ steps.set_inputs.outputs.image_family }} \
            --project=${{ steps.set_inputs.outputs.gcp_project_id }} \
            --format=json)

          # Extract image details
          IMAGE_ID=$(echo "$IMAGE_INFO" | jq -r '.id')
          IMAGE_NAME=$(echo "$IMAGE_INFO" | jq -r '.name')
          IMAGE_SELF_LINK=$(echo "$IMAGE_INFO" | jq -r '.selfLink')
          IMAGE_CREATION_TIME=$(echo "$IMAGE_INFO" | jq -r '.creationTimestamp')
          IMAGE_SIZE_GB=$(echo "$IMAGE_INFO" | jq -r '.diskSizeGb')

          # Set outputs
          echo "image_id=$IMAGE_ID" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "image_self_link=$IMAGE_SELF_LINK" >> $GITHUB_OUTPUT

          # Display information
          echo "=========================================="
          echo "âœ… IMAGE BUILD COMPLETE"
          echo "=========================================="
          echo ""
          echo "ðŸ“¦ Image Details:"
          echo "  ID:           $IMAGE_ID"
          echo "  Name:         $IMAGE_NAME"
          echo "  Family:       ${{ steps.set_inputs.outputs.image_family }}"
          echo "  Project:      ${{ steps.set_inputs.outputs.gcp_project_id }}"
          echo "  Size:         ${IMAGE_SIZE_GB} GB"
          echo "  Created:      $IMAGE_CREATION_TIME"
          echo ""
          echo "ðŸ”— Self Link:"
          echo "  $IMAGE_SELF_LINK"
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ Usage Instructions"
          echo "=========================================="
          echo ""
          echo "Deploy with gcloud:"
          echo "  gcloud compute instances create my-vm \\"
          echo "    --image=$IMAGE_NAME \\"
          echo "    --project=${{ steps.set_inputs.outputs.gcp_project_id }} \\"
          echo "    --zone=${{ steps.set_inputs.outputs.gcp_zone }}"
          echo ""
          echo "Or use image family (recommended):"
          echo "  gcloud compute instances create my-vm \\"
          echo "    --image-family=${{ steps.set_inputs.outputs.image_family }} \\"
          echo "    --project=${{ steps.set_inputs.outputs.gcp_project_id }} \\"
          echo "    --zone=${{ steps.set_inputs.outputs.gcp_zone }}"
          echo ""
          echo "Terraform data source:"
          echo "  data \"google_compute_image\" \"workshop\" {"
          echo "    family  = \"${{ steps.set_inputs.outputs.image_family }}\""
          echo "    project = \"${{ steps.set_inputs.outputs.gcp_project_id }}\""
          echo "  }"
          echo ""
          echo "=========================================="

      - name: Create image manifest
        run: |
          cat > image-manifest.json <<EOF
          {
            "image_id": "${{ steps.get_image_info.outputs.image_id }}",
            "image_name": "${{ steps.get_image_info.outputs.image_name }}",
            "image_family": "${{ steps.set_inputs.outputs.image_family }}",
            "image_self_link": "${{ steps.get_image_info.outputs.image_self_link }}",
            "gcp_project_id": "${{ steps.set_inputs.outputs.gcp_project_id }}",
            "gcp_region": "${{ steps.set_inputs.outputs.gcp_region }}",
            "gcp_zone": "${{ steps.set_inputs.outputs.gcp_zone }}",
            "source_repo": "${{ steps.set_inputs.outputs.source_repo_url }}",
            "source_ref": "${{ steps.set_inputs.outputs.source_repo_ref }}",
            "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}"
          }
          EOF

          echo "ðŸ“„ Image Manifest:"
          cat image-manifest.json | jq .

      - name: Upload image manifest
        uses: actions/upload-artifact@v4
        with:
          name: image-manifest
          path: image-manifest.json
          retention-days: 90

